{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>üìö Test Library</h2>
    <p>All your generated tests in one place.</p>
</div>

{% if tests %}
<ul class="test-list">
    {% for test in tests %}
    <li class="test-item">
        <div class="test-info">
            <h3>{{ test.name }}</h3>
            <div class="test-meta">
                <span>üìÖ {{ test.created }}</span> |
                <span>üî¢ {{ test.activities }} activities</span> |
                <span>üíæ {{ test.size }}</span>
            </div>
        </div>
        <div class="test-actions">
            <button onclick="runTest('{{ test.filename }}')" class="btn btn-primary">‚ñ∂Ô∏è Run Test</button>
            <a href="/test-editor/{{ test.filename }}" class="btn btn-warning">‚úèÔ∏è Edit</a>
            <a href="/api/test/{{ test.filename }}/download" class="btn">üì• Download</a>
            <button onclick="deleteTest('{{ test.filename }}')" class="btn btn-danger">üóëÔ∏è Delete</button>
        </div>
    </li>
    {% endfor %}
</ul>
{% else %}
<div class="alert alert-info">
    <p>üì≠ No tests yet. Create your first test using Natural Language or Screenshot Upload!</p>
</div>
{% endif %}

<!-- Test execution results modal -->
<div id="testResultModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
    <div style="max-width: 900px; margin: 50px auto; background: white; border-radius: 10px; padding: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 id="modalTitle">Test Execution Results</h2>
            <button onclick="closeModal()" class="btn btn-danger">‚úï Close</button>
        </div>
        <div id="modalContent"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
async function deleteTest(filename) {
    if (!confirm('Are you sure you want to delete this test?')) return;
    
    try {
        const response = await fetch(`/api/test/${filename}/delete`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to delete test: ' + data.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function runTest(filename) {
    // Show modal with loading state
    const modal = document.getElementById('testResultModal');
    const modalContent = document.getElementById('modalContent');
    const modalTitle = document.getElementById('modalTitle');
    
    modalTitle.textContent = '‚ñ∂Ô∏è Running Test...';
    modalContent.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <p>Executing test "${filename}"...</p>
            <p style="color: #666; font-size: 14px;">A browser window will open. Please wait...</p>
        </div>
    `;
    modal.style.display = 'block';
    
    try {
        const response = await fetch(`/api/test/${filename}/run`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        modalTitle.textContent = data.success ? '‚úÖ Test Completed' : '‚ùå Test Failed';
        
        // Build steps HTML
        let stepsHtml = '';
        if (data.steps && data.steps.length > 0) {
            stepsHtml = '<div style="margin-top: 20px;"><h3>Execution Steps:</h3><ul style="list-style: none; padding: 0;">';
            data.steps.forEach(step => {
                const icon = step.status === 'success' ? '‚úÖ' : step.status === 'failed' ? '‚ùå' : '‚è≠Ô∏è';
                const color = step.status === 'success' ? '#28a745' : step.status === 'failed' ? '#dc3545' : '#6c757d';
                stepsHtml += `
                    <li style="padding: 10px; margin: 5px 0; background: #f8f9fa; border-left: 4px solid ${color}; border-radius: 4px;">
                        <strong>${icon} Step ${step.step}: ${step.action}</strong>
                        ${step.details ? '<br><span style="color: #666;">' + step.details + '</span>' : ''}
                        ${step.error ? '<br><span style="color: #dc3545;">Error: ' + step.error + '</span>' : ''}
                    </li>
                `;
            });
            stepsHtml += '</ul></div>';
        }
        
        modalContent.innerHTML = `
            <div class="alert ${data.success ? 'alert-success' : 'alert-error'}">
                <h3>${data.success ? '‚úÖ Test Passed' : '‚ùå Test Failed'}</h3>
                <div style="margin-top: 15px;">
                    <p><strong>Test:</strong> ${data.test_name}</p>
                    <p><strong>Duration:</strong> ${data.duration ? data.duration.toFixed(2) + 's' : 'N/A'}</p>
                    <p><strong>Total Steps:</strong> ${data.total_steps}</p>
                    <p><strong>Executed:</strong> ${data.executed_steps}</p>
                    <p><strong>Failed:</strong> ${data.failed_steps}</p>
                    ${data.error ? '<p style="color: #dc3545;"><strong>Error:</strong> ' + data.error + '</p>' : ''}
                </div>
                ${stepsHtml}
            </div>
        `;
    } catch (error) {
        modalTitle.textContent = '‚ùå Execution Error';
        modalContent.innerHTML = `
            <div class="alert alert-error">
                <h3>‚ùå Error</h3>
                <p>${error.message}</p>
            </div>
        `;
    }
}

function closeModal() {
    document.getElementById('testResultModal').style.display = 'none';
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('testResultModal');
    if (event.target === modal) {
        closeModal();
    }
});
</script>
{% endblock %}